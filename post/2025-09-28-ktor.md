---
layout: post
title: "Ktor study"
date: 2025-09-28 21:45:48 +0800
tag: "Ktor|Server"
---

### Caching Headers
https://ktor.io/docs/server-caching-headers.html#configure

### RequestBodyLimit
ktor/ktor-server/ktor-server-plugins/ktor-server-body-limit/common/src/io/ktor/server/plugins/bodylimit/RequestBodyLimit.kt

限制request body 字节数， 如果超过限制， 则返回413 Payload Too Large。

### AutoHeadResponse
某个路由定义了 GET 处理器时，它会自动生成对应的 HEAD 处理器，不需要你手动写。
```
curl -I -X HEAD http://localhost:8082/head
```
不返回body

### ConditionalHeaders

1. ETag

服务器会在响应里加上 ETag 头，通常是一个哈希值或版本号。

客户端下次请求时，可以带上 If-None-Match 头，把上次的 ETag 发给服务器。 (-H 'If-None-Match: "abc123"')

服务器比对 ETag：

一样：说明资源没变 → 返回 304 Not Modified（不传 body，客户端用缓存）。

不一样：说明资源更新了 → 返回 200 OK（新内容 + 新的 ETag）。

2. If-Modified-Since 是 HTTP 缓存验证头。
"If-Modified-Since: Fri, 04 Mar 2022 09:52:07 GMT"

客户端告诉服务器：“我这边有个缓存，它最后修改时间是 xxx，如果你的资源在这之后没更新，就别传 body 给我了。”

服务器检查资源的 Last-Modified 时间：

如果 没有更新 → 返回 304 Not Modified（只发 headers，不发 body）。

如果 有更新 → 返回 200 OK + 新内容。

### Compression

- 客户端请求头

客户端用这些头告诉服务器自己支持哪些压缩方式。

`Accept-Encoding: gzip, deflate, br`

- 服务器响应头

服务器用这些头告诉客户端实际用了什么压缩方式。

`Content-Encoding: gzip` 

### DefaultHeaders

默认两个Header， 也可以自定义

Date: Sun, 28 Sep 2025 04:31:05 GMT

Server: Ktor/3.2.3

### DoubleReceive

TODO

### ForwardedHeaders

TODO

### FreeMarker/Mustache/JTE/Pebble/Thymeleaf/Velocity

常用于：生成 HTML 页面、邮件内容、文档等。

https://ktor.io/docs/server-templating.html

### HSTS

TODO

### HttpsRedirect
A plugin that redirects all HTTP requests to the HTTPS

### XHttpMethodOverride

ktor-server-method-override 插件会拦截请求，
检查是否有 方法覆盖标识，然后修改 call.request.httpMethod。

支持的覆盖方式：

 - HTTP Header 
X-HTTP-Method-Override: DELETE

 - 表单字段

POST /resource，body 里有 _method=DELETE

### MicrometerMetrics

自动收集 HTTP 请求指标，并注册到 Micrometer 的 MeterRegistry 里。

### PartialContent 
安装 PartialContent 插件 后，Ktor 会自动识别请求里的 Range 头，帮你切片返回，支持 206 Partial Content。

Request Header:

Range: bytes=0-1023

Response:
206 Partial Content

p.s.
返回body必须是ReadChannelContent

### RateLimit

Rate limiting（限流） = 限制用户在一定时间内的请求次数.

请求次数过多会返回

HTTP/1.1 429 Too Many Requests


### RequestValidation

Ktor 里的 请求校验插件（RequestValidation）。装上后，你可以为反序列化后的类型（如 data class）注册校验规则；

当你在路由里 call.receive<T>() 时，会自动触发对应的校验。


### StatusPage

StatusPages 是 Ktor 的“统一错误与状态响应”插件：拦截未处理异常或特定状态码，返回自定义内容（HTML/JSON/文本/文件）


### Sessions

TODO

### SSE

TODO

### WebSockets

TODO


### openAPI / swaggerUI
TODO
